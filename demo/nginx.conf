# nginx.conf
worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  # Logs (opcional)
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  # Compresión básica
  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/xml;
  gzip_min_length 1024;

  # Upstream al backend FastAPI (ajusta el nombre del servicio si hace falta)
  upstream backend_api {
    server code-executor-api:8000;
    keepalive 16;
  }

  server {
    listen 80;
    server_name _;

    # Para payloads un poco más grandes
    client_max_body_size 2m;

    # Timeouts altos (compilaciones y runs pesados)
    proxy_read_timeout  300s;
    proxy_send_timeout  300s;
    send_timeout        300s;

    # Headers de seguridad razonables
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header Referrer-Policy no-referrer always;
    add_header X-XSS-Protection "1; mode=block" always;
    # COOP/COEP opcionales si los querés
    # add_header Cross-Origin-Opener-Policy same-origin always;
    # add_header Cross-Origin-Embedder-Policy require-corp always;

    # Redirigimos raíz a la UI
    location = / {
      return 302 /ui;
    }

    # Evita ruidito por favicon
    location = /favicon.ico {
      return 204;
    }

    # Por simplicidad, todo lo demás al backend
    location / {
      proxy_http_version 1.1;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://backend_api;
    }
  }
}